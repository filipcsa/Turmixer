<!DOCTYPE html>
<html>
    <head>
        <link rel="stylesheet" type="text/css" href="style.css">
        <script src="https://cdnjs.cloudflare.com/ajax/libs/jsmediatags/3.9.0/jsmediatags.min.js"></script>
        <title>Turmixer</title>
    </head>

    <body>
        <main>
            <nav class="left">
                <div class="upper">
                        <h1>Playlists</h1>
                </div>
                <ul class="playlists">

                </ul>
            </nav>
            <div class="right">
                <div class="upper player">
                    <audio>
                    </audio>
                    <div class="playlistToggle">
                        Toggle
                    </div>
                    Player here
                </div>
                <div class="selectedPlaylist" ondrop="dropHandler(event);" ondragover="dragOverHandler(event);">
                    Selected playlist here
                </div>
            </div>
        </main>
        <footer>
            Icons made by <a href="https://www.flaticon.com/authors/google" title="Google">Google</a> from <a href="https://www.flaticon.com/" 
                title="Flaticon">www.flaticon.com</a> is licensed by <a href="http://creativecommons.org/licenses/by/3.0/"title="Creative Commons BY 3.0" target="_blank">CC 3.0 BY</a>
        </footer>
    </body>

    <script>

        // some global variables, all the playlists and the selected one, some elements i need later
        // and the audio
        var playlists = [];
        var selectedPlaylist = null;
        var selectedPlaylistDiv = document.querySelector('.selectedPlaylist');
        var audio = document.querySelector('audio');
        var jsmediatags = window.jsmediatags;

        // logic for toggling the playlist menu od the left
        var playlistToggleBtn = document.querySelector('.playlistToggle');
        playlistToggleBtn.addEventListener('click', togglePlaylist, false);
        function togglePlaylist() {
            let leftMenu = document.querySelector('.left');
            leftMenu.classList.toggle('toggled');

        }

        /** A class to represent a playlist
        it consists of a title and a list of tracks (their storage on HD) **/
        class Playlist {
            constructor(title) {
                this.title = title;
                this.tracks = [];
                this.selectedTrack = null;

                // create list item, add event listener and add to DOM
                this.li = document.createElement('li');
                this.li.innerText = title;
                this.li.addEventListener('click', this.onPlaylistClicked.bind(this), false);
                let playlistsUL = document.querySelector('.playlists');
                playlistsUL.appendChild(this.li);
                console.log(playlistsUL);
            }
            
            // when this playlist is clicked
            onPlaylistClicked() {
                if (selectedPlaylist != null) {
                    selectedPlaylist.li.classList.remove('selected');
                }    
                this.li.classList.add('selected');
                selectedPlaylist = this;
                console.log(`${this.title} clicked!`);
                selectedPlaylistDiv.innerHTML = "";
                this.tracks.forEach(this.displayTrack.bind(this));
            }

            // displays the track and adds event listener to it
            displayTrack(track) {
                let el = document.createElement('li');
                
                let url =  track;//"https://cors-anywhere.herokuapp.com/" + track;
                jsmediatags.read(url, {
                    onSuccess: function(tag) {
                        console.log(tag);
                        el.innerText = tag.tags.title;
                    }
                });
                
                el.innerText = track;

                el.track = track;
                el.addEventListener('click', this.onTrackClicked, false);
                selectedPlaylistDiv.appendChild(el);
            }

            onTrackClicked(event) {
                console.log(event.target.track);
                audio.src = event.target.track;
                audio.play();
                console.log("Track clicked");
            }

            // method to add tracks, can add track song or array of tracks
            addSong(path) {
                if (Array.isArray(path)) {
                    this.tracks = this.tracks.concat(path);
                }
                else { 
                    this.tracks.push(path);
                }
            }
            
            // function to save the current playlist to local storage
            saveToLS() {
                localStorage.setItem(this.title, JSON.stringify(this));
            }
        }

        // Drag and drop based on MDN example
        function dropHandler(ev) {
            ev.preventDefault();
            console.log("File dropped");
            if (ev.dataTransfer.items) {
                // Use DataTransferItemList interface to access the file(s)
                for (var i = 0; i < ev.dataTransfer.items.length; i++) {
                    // If dropped items aren't files, reject them
                    if (ev.dataTransfer.items[i].kind === 'file') {
                        var file = ev.dataTransfer.items[i].getAsFile();
                        f = URL.createObjectURL(file);
                        console.log(f);
                        audio.src = f;
                        audio.play();
                        
                        console.log('... file[' + i + '].name = ' + file.name);
                    }
                }
            } else {
                // Use DataTransfer interface to access the file(s)
                for (var i = 0; i < ev.dataTransfer.files.length; i++) {
                console.log('... file[' + i + '].name = ' + ev.dataTransfer.files[i].name);
                }
            }

        }
        function dragOverHandler(ev) {
            console.log('File(s) in drop zone'); 

            // Prevent default behavior (Prevent file from being opened)
            ev.preventDefault();
        }


        // some initial playlists for testing
        const p1 = new Playlist('Rock');
        const p3 = new Playlist('Local')
        p1.addSong(['https://playx.fun/MvWBZB:Vtx1rB',
        'https://www.bensound.org/bensound-music/bensound-anewbeginning.mp3', 
        'https://www.bensound.org/bensound-music/bensound-punky.mp3', 
        'https://www.bensound.org/bensound-music/bensound-goinghigher.mp3', 
        'https://www.bensound.org/bensound-music/bensound-beyondtheline.mp3', 
        'https://www.bensound.org/bensound-music/bensound-rumble.mp3']);
        p3.addSong(['local/minor.mp3', 'local/moskau.mp3']);
        playlists.push(p1);
        playlists.push(p3);

        function displayAvailablePlaylists() {

        }

        function initPlaylists() {
            JSON.parse(localStorage.getItem('playlists'));
        }
    </script>
</html>