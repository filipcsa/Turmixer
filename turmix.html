<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8"/>
        <link rel="stylesheet" type="text/css" href="style.css">
        <script src="./dist/musicmetadata.js"></script>
        <script src="playlist.js"></script>
        <script src="idb.js"></script>
        <title>Turmixer</title>
    </head>

    <body>
        <main>
            <nav class="left">
                <div class="upper">
                        <h1>Playlists</h1>
                </div>
                <ul class="playlists">

                </ul>
                <div class="managePlaylists">
                        <div class="addPlaylist"></div>
                        <div class="removePlaylist"></div>
                </div>
            </nav>
            <div class="right">
                <div class="upper player">
                    <audio>
                    </audio>
                    <div class="playlistToggle">
                    </div>
                    <div class="spacing"></div>

                    <div id="playToggle" class="pause">
                    </div>

                    <div id="soundToggle" class="sound">
                    </div>

                    <h4 class="currentSong">Current song</h4>

                    <div class="visual">
                        <canvas class="visualizer"></canvas>
                        <div class="progressbckgrnd">
                            <div class="progress"></div>
                        </div>
                    </div>
                </div>
        
                <div class="selectedPlaylist" ondrop="dropHandler(event);" ondragover="dragOverHandler(event);">

                </div>              
            </div>
        </main>
        <div class="modal" id="modalAdd">
            <div class="modalAddContent">
                <h5>Enter the title of the new playlist</h5>
              
                    <input type="text" id="pltitle" value="Custom"> <br>
                    <button id="addPlBtn">Add</button>
              
            </div>
        </div>
        <div class="modal" id="modalRemove">
            <div class="modalRemoveContent">
                <h5>Remove selected playlist?</h5>
                <div class="buttons">
                    <button id="yes" style="margin-right: 2em">Yes</button> <button id="no">No</button>
                </div>
            </div>
        </div>
        <footer>
            Icons made by <a href="https://www.flaticon.com/authors/google" title="Google">Google</a> from <a href="https://www.flaticon.com/" 
                title="Flaticon">www.flaticon.com</a> is licensed by <a href="http://creativecommons.org/licenses/by/3.0/" title="Creative Commons BY 3.0" target="_blank">CC 3.0 BY</a>
        </footer>

        <script>

            // some global variables, all the playlists and the selected one, some elements i need later
            // and the audio
            var playlists = [];
            var selectedPlaylist = null;
            var selectedPlaylistDiv = document.querySelector('.selectedPlaylist');
            var audio = document.querySelector('audio');
    
            // logic for toggling the playlist menu od the left
            var playlistToggleBtn = document.querySelector('.playlistToggle');
            playlistToggleBtn.addEventListener('click', togglePlaylist, false);
            function togglePlaylist() {
                let leftMenu = document.querySelector('.left');
                leftMenu.classList.toggle('toggled');
    
            }

            // Adding playlist - opening modal
            var addPlaylistBtn = document.querySelector(".addPlaylist");
            var addPlaylistModal = document.querySelector("#modalAdd");
            addPlaylistBtn.addEventListener('click', onAddPlaylistClicked);
            function onAddPlaylistClicked() {
                console.log("Add playlist clicked");
                addPlaylistModal.classList.add("visible");
            }
            // adding playlist - finalize user story in modal window
            var btnAdd = document.querySelector("#addPlBtn");
            var txtInput = document.querySelector('#pltitle');
            btnAdd.addEventListener('click', addPlaylistFinal);
            function addPlaylistFinal() {
                console.log("Add button clicked");
                let txt = txtInput.value;
                if (txt.length == 0) return;
                txtInput.value = "";
                const pl = new CustomPlaylist(txt);
                playlists.push(pl);
                addPlaylistModal.classList.remove("visible");
            }

            // Removing playlist - opening modal
            var rmvPlaylistBtn = document.querySelector(".removePlaylist");
            var rmvPlaylistModal = document.querySelector("#modalRemove");
            rmvPlaylistBtn.addEventListener('click', onRemovePlaylistClicked);
            function onRemovePlaylistClicked() {
                // no selected or selected is immutable
                if (selectedPlaylist == null || selectedPlaylist.title == "Immutable") return;
                console.log("Remove playlist clicked");
                rmvPlaylistModal.classList.add("visible");
            }
            var yesBtn = document.querySelector("#yes");
            var noBtn = document.querySelector("#no");
            yesBtn.addEventListener('click', onYesBtn);
            noBtn.addEventListener('click', onNoBtn);
            function onYesBtn() {
                var title = selectedPlaylist.title;
                removePlaylist(title);
                var el = document.getElementById(title);
                el.style.display = 'none';
                selectedPlaylist = p1;
                p1.displayPlaylist();
                rmvPlaylistModal.classList.remove("visible");
            }
            function onNoBtn() {
                rmvPlaylistModal.classList.remove("visible");
            }

            var soundToggle = document.querySelector("#soundToggle");
            soundToggle.addEventListener('click', toggleSound);
            function toggleSound() {
                if (!audio.muted){
                    soundToggle.classList = "";
                    soundToggle.classList.add("mute");
                    audio.muted = true;
                }
                else {
                    soundToggle.classList = "";
                    soundToggle.classList.add("sound");
                    audio.muted = false;
                }
            }

            // Toggle play
            var playToggle = document.querySelector('#playToggle');
            playToggle.addEventListener('click', togglePlay);

            function togglePlay() {
                if (audio.src == '') return;
                console.log("Play btn clicked!")
                if (audio.paused) {
                    audio.play();
                    playToggle.classList = "";
                    playToggle.classList.add('play');
                }

                else if (audio.played) {
                    console.log("Audio played, so pause");
                    audio.pause();
                    playToggle.classList = "";
                    playToggle.classList.add('pause');
                }
            }

            // The progress bar, inspired by https://codepen.io/mdf/pen/ZWbvBv
            var timer;
            var percent = 0;
            audio.addEventListener("playing", function(_event) {
                clearTimeout(timer); //aby to neskakalo jak u blbejch na dvorku
                var duration = _event.target.duration;
                advance(duration, audio);
            });
            audio.addEventListener("pause", function(_event) {
                clearTimeout(timer);
            });
            var advance = function(duration, element) {
                var progress = document.querySelector(".progress");
                increment = 10/duration
                percent = Math.min(increment * element.currentTime * 10, 100);
                progress.style.width = percent+'%'
                startTimer(duration, element);
            }
            var startTimer = function(duration, element){ 
                if(percent < 100) {
                    timer = setTimeout(function (){advance(duration, element)}, 100);
                }
            }
                
            
            // The visualizer inspired by MDN 
            var src = null;
            audio.addEventListener("playing", function(_event) {
                if (selectedPlaylist.type == "immutable" || src != null) return;
                var context = new AudioContext();
                src = context.createMediaElementSource(audio);
                var analyser = context.createAnalyser();
                var canvas = document.querySelector(".visualizer");

                var ctx = canvas.getContext("2d");
                src.connect(analyser);
                analyser.connect(context.destination);
                analyser.fftSize = 256;
                var bufferLength = analyser.frequencyBinCount;

                var dataArray = new Uint8Array(bufferLength);

                var WIDTH = canvas.width;
                var HEIGHT = canvas.height;

                var barWidth = (WIDTH / bufferLength) * 2.5;
                var barHeight;
                var x = 0;

                function renderFrame() {
                    requestAnimationFrame(renderFrame);
                    x = 0;
                    analyser.getByteFrequencyData(dataArray);
                    ctx.clearRect(0, 0, canvas.width, canvas.height);

                    // normalization ruins the CPU
                    // tho it would be the best way to visualize audio :/
                    //let max_x = Math.max.apply(Math, dataArray);
                    //let min_x = Math.min.apply(Math, dataArray);

                    for (var i = 0; i < bufferLength; i++) {
                        var x_1 = dataArray[i];
                        var barHeight = (HEIGHT)*((x_1)/(420));
                        
                        var r = 10 * (25 * (i/bufferLength));
                        var g = 250 * (i/bufferLength);
                        var b = barHeight + 50;

                        ctx.fillStyle = "rgb(" + r + "," + g + "," + b + ")";
                        ctx.fillRect(x, (HEIGHT - barHeight)/2, barWidth, barHeight);

                        x += barWidth + 1 ;
                    }
                }
                audio.play();
                renderFrame();
            });
    
            // Drag and drop based on MDN example
            function dropHandler(ev) {
                ev.preventDefault();
                console.log("File dropped");
                if (ev.dataTransfer.items) {
                    // Use DataTransferItemList interface to access the file(s)
                    for (var i = 0; i < ev.dataTransfer.items.length; i++) {
                        // If dropped items aren't files, reject them
                        if (ev.dataTransfer.items[i].kind === 'file') {
                            var file = ev.dataTransfer.items[i].getAsFile();
                            if (file instanceof Blob) {
                                console.log("File is a blob as all things should be")
                            }
                            f = URL.createObjectURL(file);
                            console.log(f);
                            if (selectedPlaylist.type == "immutable") return;
                            selectedPlaylist.addSong(file);
                            selectedPlaylist.displayPlaylist();
                            console.log('... file[' + i + '].name = ' + file.name);
                        }
                    }
                } else {
                    // Use DataTransfer interface to access the file(s)
                    for (var i = 0; i < ev.dataTransfer.files.length; i++) {
                    console.log('... file[' + i + '].name = ' + ev.dataTransfer.files[i].name);
                    }
                }
    
            }
            function dragOverHandler(ev) {
                console.log('File(s) in drop zone'); 
    
                // Prevent default behavior (Prevent file from being opened)
                ev.preventDefault();
            }
    
    
            // some initial playlists for testing
            const p1 = new Playlist('Immutable');
            const song1 = new Song('http://fredfred.net/skriker/download/music/Django_Reinhardt-Minor_swing.mp3',
            'Minor swing', 'Django Reinhardt', 'https://images-na.ssl-images-amazon.com/images/I/91yLj1FzQCL._SY355_.jpg');
            const song2 = new Song('https://a.tumblr.com/tumblr_lru8tfFmwN1qzat1go1.mp3', 'The Good, The Bad and The Ugly',
            'Ennio Morricone', 'https://images-na.ssl-images-amazon.com/images/I/612km2U7SSL._SY355_.jpg');
            const song3 = new Song('https://a.tumblr.com/tumblr_lq3a0zKoSn1qjcjsyo1.mp3', 'Should I stay or should I go', 
            'The Clash', 'https://res.cloudinary.com/teepublic/image/private/s--z9FceAtJ--/t_Preview/b_rgb:191919,c_limit,f_jpg,h_630,q_90,w_630/v1472673652/production/designs/600701_2.jpg');

            
            p1.addSong(song1);
            p1.addSong(song2);
            p1.addSong(song3);

            playlists.push(p1);

        </script>
    </body>
</html>